<!DOCTYPE html>
<html>
<head>
  <title>Sprite Coverage Test - White Rectangle Fix Verification</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      background: #1a1a1a;
      font-family: 'Courier New', monospace;
      color: #0f0;
    }
    h1 { color: #0f0; text-align: center; }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    canvas {
      border: 2px solid #0f0;
      background: #000;
      image-rendering: pixelated;
      display: block;
      margin: 20px auto;
    }
    .results {
      background: #000;
      border: 2px solid #0f0;
      padding: 20px;
      margin: 20px 0;
      font-size: 14px;
      line-height: 1.6;
    }
    .pass { color: #0f0; }
    .fail { color: #f00; }
    .info { color: #ff0; }
    .sprite-info {
      margin: 10px 0;
      padding: 10px;
      background: #222;
      border-left: 3px solid #0f0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç SPRITE COVERAGE TEST</h1>
    <div class="results" id="results">Initializing test...</div>
    <canvas id="canvas" width="800" height="600"></canvas>
  </div>

  <script type="module">
    import { AssetLoader } from './js/core/AssetLoader.js';
    import { SpriteAtlas } from './js/core/SpriteAtlas.js';

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const resultsDiv = document.getElementById('results');

    ctx.imageSmoothingEnabled = false;

    let testResults = [];

    function addResult(type, message) {
      const className = type === 'pass' ? 'pass' : type === 'fail' ? 'fail' : 'info';
      testResults.push(`<div class="${className}">${type === 'pass' ? '‚úì' : type === 'fail' ? '‚úó' : '‚Üí'} ${message}</div>`);
      updateResults();
    }

    function updateResults() {
      resultsDiv.innerHTML = testResults.join('');
    }

    async function runTest() {
      try {
        addResult('info', 'Loading assets...');

        const assetLoader = new AssetLoader();
        await assetLoader.loadAll([
          { type: 'image', key: 'island', path: 'island_bg.png' },
          { type: 'atlas', key: 'fish', imagePath: 'fish_characters.png', jsonPath: 'fish_characters.json' },
          { type: 'atlas', key: 'terrain', imagePath: 'terrain_flora.png', jsonPath: 'terrain_flora.json' }
        ]);

        const spriteAtlas = new SpriteAtlas(assetLoader);
        addResult('pass', 'All assets loaded successfully');

        // Draw island background
        const islandBg = assetLoader.getImage('island');
        ctx.drawImage(islandBg, 0, 0, islandBg.width, islandBg.height, 0, 0, 800, 600);
        addResult('pass', `Island background rendered (${islandBg.width}√ó${islandBg.height})`);

        // Define interactables with their expected 50√ó50 areas
        const interactables = [
          {
            x: 250, y: 450, w: 50, h: 50,
            label: 'Go Fishing',
            sprite: 'sand_rect',
            color: '#ff0000'
          },
          {
            x: 150, y: 200, w: 50, h: 50,
            label: 'Count Fish',
            sprite: 'bush_large',
            color: '#00ff00'
          },
          {
            x: 550, y: 220, w: 50, h: 50,
            label: 'Learn Letters',
            sprite: 'bush_medium',
            color: '#0000ff'
          }
        ];

        addResult('info', '<br><strong>Testing Interactable Sprite Coverage:</strong>');

        for (const inter of interactables) {
          // Draw outline of expected area
          ctx.strokeStyle = inter.color;
          ctx.lineWidth = 2;
          ctx.setLineDash([5, 5]);
          ctx.strokeRect(inter.x, inter.y, inter.w, inter.h);
          ctx.setLineDash([]);

          // Get sprite frame info
          const terrainAtlas = assetLoader.getAtlas('terrain');
          const frame = terrainAtlas.frames[inter.sprite];

          if (!frame) {
            addResult('fail', `${inter.label}: Sprite '${inter.sprite}' NOT FOUND`);
            continue;
          }

          const spriteW = frame.frame.w;
          const spriteH = frame.frame.h;

          // Draw sprite
          spriteAtlas.drawSprite(ctx, 'terrain', inter.sprite, inter.x, inter.y, 1.0);

          // Check coverage
          const coversWidth = spriteW >= inter.w;
          const coversHeight = spriteH >= inter.h;
          const fullCoverage = coversWidth && coversHeight;

          const coverageStatus = fullCoverage ? 'pass' : 'fail';
          const coverageMsg = fullCoverage ? 'FULL COVERAGE ‚úì' : 'INCOMPLETE COVERAGE ‚úó';

          addResult(coverageStatus,
            `<div class="sprite-info">
              <strong>${inter.label}</strong> at (${inter.x}, ${inter.y})<br>
              ‚Üí Sprite: ${inter.sprite} (${spriteW}√ó${spriteH})<br>
              ‚Üí Required: ${inter.w}√ó${inter.h}<br>
              ‚Üí Width: ${coversWidth ? '‚úì' : '‚úó'} (${spriteW} ${coversWidth ? '‚â•' : '<'} ${inter.w})<br>
              ‚Üí Height: ${coversHeight ? '‚úì' : '‚úó'} (${spriteH} ${coversHeight ? '‚â•' : '<'} ${inter.h})<br>
              ‚Üí Status: <strong>${coverageMsg}</strong>
            </div>`
          );

          // Draw sprite bounding box in yellow
          ctx.strokeStyle = '#ffff00';
          ctx.lineWidth = 1;
          ctx.strokeRect(inter.x, inter.y, spriteW, spriteH);
        }

        // Draw player
        spriteAtlas.drawSprite(ctx, 'fish', 'char_child', 400, 300, 1);
        addResult('pass', 'Player character rendered at (400, 300)');

        // Legend
        ctx.font = '14px monospace';
        ctx.fillStyle = '#fff';
        ctx.fillText('Legend:', 20, 30);
        ctx.fillStyle = '#ff0000';
        ctx.fillText('Red dashed = Fishing area', 20, 50);
        ctx.fillStyle = '#00ff00';
        ctx.fillText('Green dashed = Counting area', 20, 70);
        ctx.fillStyle = '#0000ff';
        ctx.fillText('Blue dashed = Letters area', 20, 90);
        ctx.fillStyle = '#ffff00';
        ctx.fillText('Yellow solid = Sprite bounds', 20, 110);

        addResult('info', '<br><strong>Test Complete!</strong> Check canvas above.');
        addResult('info', 'Dashed colored boxes = expected 50√ó50 interactable areas');
        addResult('info', 'Yellow solid boxes = actual sprite dimensions');
        addResult('info', 'If yellow box ‚â• colored box, white backgrounds are covered ‚úì');

      } catch (error) {
        addResult('fail', `ERROR: ${error.message}`);
        console.error(error);
      }
    }

    runTest();
  </script>
</body>
</html>
